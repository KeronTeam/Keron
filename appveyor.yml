version: 1.0.{build}
branches:
  only:
  - master
configuration:
  - Debug
  - Release
platform:
  - x86
  - x64
environment:
  archive_pwd:
    secure: /dBxnu4DmsDVzbqPnYSnLGrPZRrrj9w2BNGhxjHaPzTYD1FNs71/h791kE0drs/P
  archive_url:
    secure: w73CoBg7zMyE6aUPAuWFbKfuqzJMtHF9w0Ehe3jL1bQEoh3PD4LMAaS9BZEUEjD7SAjPii7YYE4dQBk57s1FdQ==
  matrix:
  - VS_VERSION: vs2013
notifications:
  - provider: Slack
    auth_token:
      secure: /yDzKEpMQgO35iY7j+jAVUMy+SIk7lXe+JTCSdFM5Ap0tAMI/KcUNqp+dYKAWdj+
    channel: general
install:
  - cinst -y curl
  - cinst -v -f -y devbox-common.extension
  #- cinst -v -f -y devbox-sed
  - curl -sSL -o premake.zip https://github.com/premake/premake-core/releases/download/v5.0.0.alpha4/premake-5.0.0.alpha4-windows.zip
  - unzip premake.zip
  - move bin\release\premake5.exe .
  - curl -sSL --insecure -o ksp-runtime.7z %archive_url%
  - 7z x -p%archive_pwd% ksp-runtime.7z
before_build:
  - git submodule init
  - git submodule update
  - del /F /S build
  - premake5.exe --arch=%PLATFORM% --ksp=KSP_runtime %VS_VERSION%
  - dir
  - dir build
  #- sed -i "/<PropertyGroup>/a<NoStdLib>true<\/NoStdLib>" build\ENet-net.csproj
  - tree
build:
  project: build\Keron.sln
  verbosity: normal
after_build:
  - if "%PLATFORM%"=="x86" move /y build\%CONFIGURATION%-x32 build\%CONFIGURATION%-x86
  - tree
artifacts:
  - path: build\$(configuration)-$(platform)
    name: keron-win-$(configuration)-$(platform)-$(VS_VERSION)
    type: zip

deploy:
  # Easy merging with Travis which cannot (yet) set a release name...
  release: $(appveyor_repo_tag_name)
  provider: GitHub
  auth_token:
    secure: 57Q/XmAwYwOJfkfUv6axIuO4ZPQsrB3AbjH6ofQki1hLkolCii42C7ZnLYkDn/eY
  artifact: keron-win-$(configuration)-$(platform)-$(VS_VERSION)
  draft: true
  on:
    branch: master
    appveyor_repo_tag: true
    configuration: Release
